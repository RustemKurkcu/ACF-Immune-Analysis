################################################################################
# ACF IMMUNE GENE EXPRESSION ANALYSIS - MASTER PIPELINE
################################################################################
#
# Project: Epithelial-Stromal Microenvironment in Early Colonic Neoplasia
# Author: Generated by SuperNinja AI Agent
# Date: October 19, 2025
# 
# Description: Complete reproducible analysis pipeline for ACF immune gene
#              expression profiling using Oncomine Immune Response Assay
#
# Study Design:
#   - 10 patients with proximal colon dysplastic ACF
#   - 40 samples: 10 patients × 2 conditions (ACF, Normal) × 2 compartments (Epi, Stro)
#   - ~395 immune-related genes profiled
#   - Technology: Ion Torrent sequencing with targeted amplicon panel
#
# Input Data:
#   - Normalized expression matrices (epithelial and stromal)
#   - Gene panel annotations
#   - Sample metadata
#
# Output:
#   - Differential expression results
#   - PCA analysis
#   - Pathway enrichment
#   - Publication-quality figures
#   - JMP-compatible data exports
#
################################################################################

# ==============================================================================
# SECTION 1: SETUP AND CONFIGURATION
# ==============================================================================

cat("\n")
cat("================================================================================\n")
cat("ACF IMMUNE ANALYSIS - MASTER PIPELINE\n")
cat("================================================================================\n")
cat("\nStarting analysis at:", as.character(Sys.time()), "\n\n")

# Clear environment
rm(list = ls())
gc()

# Set working directory (adjust as needed)
# setwd("/path/to/ACF-Immune-Analysis")

# Load required libraries
cat("Loading required libraries...\n")

required_packages <- c(
  # Data manipulation
  "tidyverse", "readxl", "writexl", "data.table",
  
  # Statistical analysis
  "DESeq2", "edgeR", "limma",
  
  # Visualization
  "ggplot2", "pheatmap", "ComplexHeatmap", "ggrepel", "cowplot",
  "RColorBrewer", "viridis", "ggsci",
  
  # Pathway analysis
  "clusterProfiler", "enrichplot", "DOSE", "org.Hs.eg.db",
  
  # Network analysis
  "igraph", "ggraph",
  
  # Immune deconvolution (optional)
  # "immunedeconv",
  
  # Utilities
  "scales", "reshape2", "gridExtra"
)

# Function to install and load packages
load_packages <- function(packages) {
  for (pkg in packages) {
    if (!require(pkg, character.only = TRUE, quietly = TRUE)) {
      cat("Installing", pkg, "...\n")
      if (pkg %in% c("DESeq2", "clusterProfiler", "enrichplot", "DOSE", 
                     "org.Hs.eg.db", "ComplexHeatmap")) {
        if (!requireNamespace("BiocManager", quietly = TRUE))
          install.packages("BiocManager")
        BiocManager::install(pkg, update = FALSE, ask = FALSE)
      } else {
        install.packages(pkg, repos = "https://cloud.r-project.org")
      }
      library(pkg, character.only = TRUE)
    }
  }
}

# Load all packages
suppressPackageStartupMessages(load_packages(required_packages))

cat("All packages loaded successfully!\n\n")

# Set global options
options(stringsAsFactors = FALSE)
theme_set(theme_bw())

# Create output directories
output_dirs <- c(
  "analysis/outputs/figures",
  "analysis/outputs/tables",
  "analysis/outputs/data",
  "analysis/outputs/jmp_export"
)

for (dir in output_dirs) {
  if (!dir.exists(dir)) {
    dir.create(dir, recursive = TRUE)
    cat("Created directory:", dir, "\n")
  }
}

cat("\n")

# ==============================================================================
# SECTION 2: DATA LOADING
# ==============================================================================

cat("================================================================================\n")
cat("SECTION 2: DATA LOADING\n")
cat("================================================================================\n\n")

# Load normalized expression data
cat("Loading normalized expression matrices...\n")

# Epithelial data
expr_epi <- read.csv("data/processed/ACF normalized epi.csv", row.names = 1)
cat("  Epithelial:", nrow(expr_epi), "genes ×", ncol(expr_epi), "samples\n")

# Stromal data
expr_stro <- read.csv("data/processed/ACF normalized stro.csv", row.names = 1)
cat("  Stromal:", nrow(expr_stro), "genes ×", ncol(expr_stro), "samples\n")

# Load gene panel information
cat("\nLoading gene panel annotations...\n")
gene_panel <- read_excel("data/metadata/Gene panel.xlsx")
cat("  Gene panel:", nrow(gene_panel), "genes with annotations\n")

# Load PCA results (if available)
cat("\nLoading PCA results...\n")
pca_coords <- read.csv("data/processed/PCA_cell.csv", row.names = 1)
pca_loadings <- read.csv("data/processed/PCA_loading.csv", row.names = 1)
cat("  PCA coordinates:", nrow(pca_coords), "samples\n")
cat("  PCA loadings:", nrow(pca_loadings), "genes\n")

# Load DGE results (if available)
cat("\nLoading differential expression results...\n")
dge_epi <- read_excel("data/processed/DGE_epithelial.xlsx")
dge_stro <- read_excel("data/processed/DGE_stromal.xlsx")
cat("  Epithelial DGE:", nrow(dge_epi), "genes\n")
cat("  Stromal DGE:", nrow(dge_stro), "genes\n")

cat("\nData loading complete!\n\n")

# ==============================================================================
# SECTION 3: METADATA PREPARATION
# ==============================================================================

cat("================================================================================\n")
cat("SECTION 3: METADATA PREPARATION\n")
cat("================================================================================\n\n")

# Parse sample names to extract metadata
parse_sample_names <- function(sample_names) {
  # Sample format: PatientID-Replicate-Compartment
  # Example: "110-1E" = Patient 110, Replicate 1, Epithelial
  
  metadata <- data.frame(
    sample_id = sample_names,
    patient_id = gsub("-.*", "", sample_names),
    replicate = gsub(".*-(\\d+)[ES].*", "\\1", sample_names),
    compartment = ifelse(grepl("E", sample_names), "Epithelial", "Stromal"),
    condition = case_when(
      grepl("1[ES]", sample_names) ~ "ACF",
      grepl("2[ES]", sample_names) ~ "Normal",
      grepl("3[ES]", sample_names) ~ "Unknown",
      TRUE ~ "Unknown"
    ),
    stringsAsFactors = FALSE
  )
  
  return(metadata)
}

# Create metadata for epithelial samples
metadata_epi <- parse_sample_names(colnames(expr_epi))
metadata_epi$group <- paste(metadata_epi$condition, metadata_epi$compartment, sep = "_")

cat("Epithelial samples:\n")
print(table(metadata_epi$condition))

# Create metadata for stromal samples
metadata_stro <- parse_sample_names(colnames(expr_stro))
metadata_stro$group <- paste(metadata_stro$condition, metadata_stro$compartment, sep = "_")

cat("\nStromal samples:\n")
print(table(metadata_stro$condition))

# Save metadata
write.csv(metadata_epi, "analysis/outputs/data/metadata_epithelial.csv", row.names = FALSE)
write.csv(metadata_stro, "analysis/outputs/data/metadata_stromal.csv", row.names = FALSE)

cat("\nMetadata preparation complete!\n\n")

# ==============================================================================
# SECTION 4: QUALITY CONTROL
# ==============================================================================

cat("================================================================================\n")
cat("SECTION 4: QUALITY CONTROL\n")
cat("================================================================================\n\n")

# Function to perform QC
perform_qc <- function(expr_data, metadata, compartment_name) {
  
  cat("Quality control for", compartment_name, "samples...\n")
  
  # 1. Expression distribution
  cat("  Checking expression distribution...\n")
  
  # Calculate summary statistics
  expr_summary <- data.frame(
    sample = colnames(expr_data),
    mean_expr = colMeans(expr_data, na.rm = TRUE),
    median_expr = apply(expr_data, 2, median, na.rm = TRUE),
    sd_expr = apply(expr_data, 2, sd, na.rm = TRUE),
    n_detected = colSums(expr_data > 0, na.rm = TRUE),
    pct_detected = colSums(expr_data > 0, na.rm = TRUE) / nrow(expr_data) * 100
  )
  
  # 2. Gene detection rate
  cat("  Checking gene detection rates...\n")
  gene_detection <- data.frame(
    gene = rownames(expr_data),
    n_samples_detected = rowSums(expr_data > 0, na.rm = TRUE),
    pct_samples_detected = rowSums(expr_data > 0, na.rm = TRUE) / ncol(expr_data) * 100,
    mean_expr = rowMeans(expr_data, na.rm = TRUE),
    sd_expr = apply(expr_data, 1, sd, na.rm = TRUE)
  )
  
  # 3. Create QC plots
  cat("  Generating QC plots...\n")
  
  # Expression distribution boxplot
  p1 <- expr_data %>%
    as.data.frame() %>%
    pivot_longer(everything(), names_to = "sample", values_to = "expression") %>%
    left_join(metadata, by = c("sample" = "sample_id")) %>%
    ggplot(aes(x = sample, y = expression, fill = condition)) +
    geom_boxplot() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    labs(title = paste(compartment_name, "- Expression Distribution"),
         x = "Sample", y = "Normalized Expression") +
    scale_fill_brewer(palette = "Set1")
  
  ggsave(paste0("analysis/outputs/figures/QC_", compartment_name, "_expression_boxplot.pdf"),
         p1, width = 12, height = 6)
  
  # Detection rate histogram
  p2 <- ggplot(gene_detection, aes(x = pct_samples_detected)) +
    geom_histogram(bins = 50, fill = "steelblue", color = "black") +
    theme_bw() +
    labs(title = paste(compartment_name, "- Gene Detection Rate"),
         x = "% Samples with Detection", y = "Number of Genes") +
    geom_vline(xintercept = 50, linetype = "dashed", color = "red")
  
  ggsave(paste0("analysis/outputs/figures/QC_", compartment_name, "_detection_rate.pdf"),
         p2, width = 8, height = 6)
  
  # Sample correlation heatmap
  sample_cor <- cor(expr_data, use = "pairwise.complete.obs")
  
  pdf(paste0("analysis/outputs/figures/QC_", compartment_name, "_correlation_heatmap.pdf"),
      width = 10, height = 10)
  pheatmap(sample_cor,
           annotation_col = metadata[, c("condition", "patient_id"), drop = FALSE],
           main = paste(compartment_name, "- Sample Correlation"),
           color = colorRampPalette(c("blue", "white", "red"))(100))
  dev.off()
  
  # Save QC results
  write.csv(expr_summary, 
            paste0("analysis/outputs/tables/QC_", compartment_name, "_sample_summary.csv"),
            row.names = FALSE)
  write.csv(gene_detection,
            paste0("analysis/outputs/tables/QC_", compartment_name, "_gene_detection.csv"),
            row.names = FALSE)
  
  cat("  QC complete for", compartment_name, "\n")
  cat("    Mean detection rate:", round(mean(gene_detection$pct_samples_detected), 1), "%\n")
  cat("    Genes detected in >50% samples:", 
      sum(gene_detection$pct_samples_detected > 50), "\n\n")
  
  return(list(
    sample_summary = expr_summary,
    gene_detection = gene_detection,
    sample_correlation = sample_cor
  ))
}

# Perform QC for both compartments
qc_epi <- perform_qc(expr_epi, metadata_epi, "Epithelial")
qc_stro <- perform_qc(expr_stro, metadata_stro, "Stromal")

cat("Quality control complete!\n\n")

# ==============================================================================
# SECTION 5: DIFFERENTIAL EXPRESSION ANALYSIS
# ==============================================================================

cat("================================================================================\n")
cat("SECTION 5: DIFFERENTIAL EXPRESSION ANALYSIS\n")
cat("================================================================================\n\n")

cat("NOTE: Using pre-computed DESeq2 results from Bo's analysis\n")
cat("      These were generated using DESeq2 v1.26.0 with separate analysis\n")
cat("      of epithelial and stromal compartments.\n\n")

# Function to process DGE results
process_dge_results <- function(dge_data, compartment_name, fc_threshold = 1.5, padj_threshold = 0.05) {
  
  cat("Processing", compartment_name, "DGE results...\n")
  
  # Add significance column
  dge_data$significant <- dge_data$padj < padj_threshold & 
    (dge_data$FC > fc_threshold | dge_data$FC < 1/fc_threshold)
  
  # Add direction column
  dge_data$direction <- case_when(
    dge_data$significant & dge_data$log2FoldChange > 0 ~ "Up in ACF",
    dge_data$significant & dge_data$log2FoldChange < 0 ~ "Down in ACF",
    TRUE ~ "Not significant"
  )
  
  # Summary statistics
  n_sig <- sum(dge_data$significant, na.rm = TRUE)
  n_up <- sum(dge_data$direction == "Up in ACF", na.rm = TRUE)
  n_down <- sum(dge_data$direction == "Down in ACF", na.rm = TRUE)
  
  cat("  Total genes:", nrow(dge_data), "\n")
  cat("  Significant genes:", n_sig, "\n")
  cat("    Upregulated:", n_up, "\n")
  cat("    Downregulated:", n_down, "\n\n")
  
  # Get top genes
  top_up <- dge_data %>%
    filter(direction == "Up in ACF") %>%
    arrange(padj) %>%
    head(20)
  
  top_down <- dge_data %>%
    filter(direction == "Down in ACF") %>%
    arrange(padj) %>%
    head(20)
  
  cat("  Top 10 upregulated genes:\n")
  print(top_up[1:min(10, nrow(top_up)), c("Gene", "log2FoldChange", "padj")])
  
  cat("\n  Top 10 downregulated genes:\n")
  print(top_down[1:min(10, nrow(top_down)), c("Gene", "log2FoldChange", "padj")])
  
  cat("\n")
  
  return(list(
    dge_full = dge_data,
    dge_sig = dge_data[dge_data$significant, ],
    top_up = top_up,
    top_down = top_down,
    summary = data.frame(
      compartment = compartment_name,
      total_genes = nrow(dge_data),
      significant = n_sig,
      upregulated = n_up,
      downregulated = n_down
    )
  ))
}

# Process both compartments
dge_results_epi <- process_dge_results(dge_epi, "Epithelial")
dge_results_stro <- process_dge_results(dge_stro, "Stromal")

# Save processed results
write_xlsx(list(
  Epithelial_All = dge_results_epi$dge_full,
  Epithelial_Significant = dge_results_epi$dge_sig,
  Stromal_All = dge_results_stro$dge_full,
  Stromal_Significant = dge_results_stro$dge_sig,
  Summary = rbind(dge_results_epi$summary, dge_results_stro$summary)
), "analysis/outputs/tables/DGE_results_processed.xlsx")

cat("Differential expression analysis complete!\n\n")

# ==============================================================================
# SECTION 6: VOLCANO PLOTS
# ==============================================================================

cat("================================================================================\n")
cat("SECTION 6: VOLCANO PLOTS\n")
cat("================================================================================\n\n")

# Function to create volcano plot
create_volcano_plot <- function(dge_data, compartment_name, 
                                fc_threshold = 1.5, padj_threshold = 0.05,
                                label_top_n = 15) {
  
  cat("Creating volcano plot for", compartment_name, "...\n")
  
  # Prepare data
  plot_data <- dge_data %>%
    mutate(
      neg_log10_padj = -log10(padj),
      color_group = case_when(
        direction == "Up in ACF" ~ "Upregulated",
        direction == "Down in ACF" ~ "Downregulated",
        TRUE ~ "Not significant"
      )
    )
  
  # Select genes to label
  genes_to_label <- plot_data %>%
    filter(significant) %>%
    arrange(padj) %>%
    head(label_top_n) %>%
    pull(Gene)
  
  plot_data$label <- ifelse(plot_data$Gene %in% genes_to_label, plot_data$Gene, "")
  
  # Create plot
  p <- ggplot(plot_data, aes(x = log2FoldChange, y = neg_log10_padj, color = color_group)) +
    geom_point(alpha = 0.6, size = 2) +
    geom_text_repel(aes(label = label), size = 3, max.overlaps = 20) +
    geom_vline(xintercept = c(-log2(fc_threshold), log2(fc_threshold)), 
               linetype = "dashed", color = "gray50") +
    geom_hline(yintercept = -log10(padj_threshold), 
               linetype = "dashed", color = "gray50") +
    scale_color_manual(values = c(
      "Upregulated" = "#E41A1C",
      "Downregulated" = "#377EB8",
      "Not significant" = "gray70"
    )) +
    theme_bw() +
    theme(
      legend.position = "top",
      panel.grid.minor = element_blank()
    ) +
    labs(
      title = paste(compartment_name, "- Volcano Plot"),
      subtitle = paste("ACF vs Normal | FC >", fc_threshold, "| padj <", padj_threshold),
      x = "log2(Fold Change)",
      y = "-log10(Adjusted P-value)",
      color = ""
    )
  
  # Save plot
  ggsave(paste0("analysis/outputs/figures/Volcano_", compartment_name, ".pdf"),
         p, width = 10, height = 8)
  
  ggsave(paste0("analysis/outputs/figures/Volcano_", compartment_name, ".png"),
         p, width = 10, height = 8, dpi = 300)
  
  cat("  Volcano plot saved!\n\n")
  
  return(p)
}

# Create volcano plots
volcano_epi <- create_volcano_plot(dge_results_epi$dge_full, "Epithelial")
volcano_stro <- create_volcano_plot(dge_results_stro$dge_full, "Stromal")

cat("Volcano plots complete!\n\n")

# ==============================================================================
# SECTION 7: HEATMAPS
# ==============================================================================

cat("================================================================================\n")
cat("SECTION 7: EXPRESSION HEATMAPS\n")
cat("================================================================================\n\n")

# Function to create expression heatmap
create_expression_heatmap <- function(expr_data, metadata, dge_results, 
                                     compartment_name, top_n = 50) {
  
  cat("Creating expression heatmap for", compartment_name, "...\n")
  
  # Select top significant genes
  top_genes <- dge_results$dge_sig %>%
    arrange(padj) %>%
    head(top_n) %>%
    pull(Gene)
  
  # Filter expression data
  expr_subset <- expr_data[rownames(expr_data) %in% top_genes, ]
  
  # Z-score normalization
  expr_scaled <- t(scale(t(expr_subset)))
  
  # Prepare annotation
  annotation_col <- metadata %>%
    select(condition, patient_id) %>%
    as.data.frame()
  rownames(annotation_col) <- metadata$sample_id
  
  # Color schemes
  ann_colors <- list(
    condition = c("ACF" = "#E41A1C", "Normal" = "#377EB8", "Unknown" = "gray70")
  )
  
  # Create heatmap
  pdf(paste0("analysis/outputs/figures/Heatmap_", compartment_name, "_top", top_n, ".pdf"),
      width = 10, height = 12)
  
  pheatmap(expr_scaled,
           annotation_col = annotation_col,
           annotation_colors = ann_colors,
           color = colorRampPalette(c("blue", "white", "red"))(100),
           scale = "none",
           clustering_distance_rows = "euclidean",
           clustering_distance_cols = "euclidean",
           clustering_method = "complete",
           show_rownames = TRUE,
           show_colnames = TRUE,
           fontsize_row = 8,
           fontsize_col = 8,
           main = paste(compartment_name, "- Top", top_n, "DE Genes"))
  
  dev.off()
  
  cat("  Heatmap saved!\n\n")
}

# Create heatmaps
create_expression_heatmap(expr_epi, metadata_epi, dge_results_epi, "Epithelial", top_n = 50)
create_expression_heatmap(expr_stro, metadata_stro, dge_results_stro, "Stromal", top_n = 50)

cat("Heatmaps complete!\n\n")

# ==============================================================================
# SECTION 8: PCA VISUALIZATION
# ==============================================================================

cat("================================================================================\n")
cat("SECTION 8: PCA VISUALIZATION\n")
cat("================================================================================\n\n")

cat("Using pre-computed PCA results from Bo's analysis...\n\n")

# Function to create PCA plot
create_pca_plot <- function(pca_coords, title = "PCA Plot") {
  
  # Parse sample names
  pca_data <- pca_coords %>%
    rownames_to_column("sample_id") %>%
    mutate(
      patient_id = gsub("\\..*", "", sample_id),
      condition = case_when(
        grepl("ACF", sample_id) ~ "ACF",
        grepl("Normal", sample_id) ~ "Normal",
        TRUE ~ "Unknown"
      ),
      compartment = case_when(
        grepl("1E|2E|3E", sample_id) ~ "Epithelial",
        grepl("1S|2S|3S", sample_id) ~ "Stromal",
        TRUE ~ "Unknown"
      )
    )
  
  # Calculate variance explained (if available)
  # This would need to be calculated from the actual PCA object
  # For now, we'll use placeholder values
  
  # Create plot
  p <- ggplot(pca_data, aes(x = PC1, y = PC2, color = compartment, shape = condition)) +
    geom_point(size = 4, alpha = 0.8) +
    scale_color_brewer(palette = "Set1") +
    scale_shape_manual(values = c("ACF" = 16, "Normal" = 17, "Unknown" = 15)) +
    theme_bw() +
    theme(
      legend.position = "right",
      panel.grid.minor = element_blank()
    ) +
    labs(
      title = title,
      x = "PC1",
      y = "PC2",
      color = "Compartment",
      shape = "Condition"
    )
  
  return(p)
}

# Create PCA plot
pca_plot <- create_pca_plot(pca_coords, "PCA - All Samples")

ggsave("analysis/outputs/figures/PCA_all_samples.pdf", pca_plot, width = 10, height = 8)
ggsave("analysis/outputs/figures/PCA_all_samples.png", pca_plot, width = 10, height = 8, dpi = 300)

cat("PCA visualization complete!\n\n")

# ==============================================================================
# SECTION 9: PATHWAY ENRICHMENT ANALYSIS
# ==============================================================================

cat("================================================================================\n")
cat("SECTION 9: PATHWAY ENRICHMENT ANALYSIS\n")
cat("================================================================================\n\n")

cat("Performing pathway enrichment analysis using clusterProfiler...\n\n")

# Function to perform GO enrichment
perform_go_enrichment <- function(gene_list, compartment_name, direction) {
  
  cat("  Analyzing", direction, "genes in", compartment_name, "...\n")
  
  if (length(gene_list) == 0) {
    cat("    No genes to analyze!\n")
    return(NULL)
  }
  
  # Convert gene symbols to Entrez IDs
  gene_entrez <- bitr(gene_list, 
                     fromType = "SYMBOL",
                     toType = "ENTREZID",
                     OrgDb = org.Hs.eg.db)
  
  if (nrow(gene_entrez) == 0) {
    cat("    No genes could be converted to Entrez IDs!\n")
    return(NULL)
  }
  
  cat("    Converted", nrow(gene_entrez), "genes to Entrez IDs\n")
  
  # GO enrichment - Biological Process
  go_bp <- enrichGO(gene = gene_entrez$ENTREZID,
                   OrgDb = org.Hs.eg.db,
                   ont = "BP",
                   pAdjustMethod = "BH",
                   pvalueCutoff = 0.05,
                   qvalueCutoff = 0.2,
                   readable = TRUE)
  
  if (!is.null(go_bp) && nrow(go_bp@result) > 0) {
    cat("    Found", nrow(go_bp@result), "enriched GO:BP terms\n")
    
    # Save results
    write.csv(go_bp@result,
             paste0("analysis/outputs/tables/GO_BP_", compartment_name, "_", direction, ".csv"),
             row.names = FALSE)
    
    # Create dot plot
    if (nrow(go_bp@result) >= 10) {
      p <- dotplot(go_bp, showCategory = 20) +
        ggtitle(paste(compartment_name, "-", direction, "- GO:BP Enrichment"))
      
      ggsave(paste0("analysis/outputs/figures/GO_BP_", compartment_name, "_", direction, ".pdf"),
             p, width = 10, height = 8)
    }
  } else {
    cat("    No enriched GO:BP terms found\n")
  }
  
  return(go_bp)
}

# Perform enrichment for epithelial genes
go_epi_up <- perform_go_enrichment(
  dge_results_epi$top_up$Gene,
  "Epithelial",
  "Upregulated"
)

go_epi_down <- perform_go_enrichment(
  dge_results_epi$top_down$Gene,
  "Epithelial",
  "Downregulated"
)

# Perform enrichment for stromal genes
go_stro_up <- perform_go_enrichment(
  dge_results_stro$top_up$Gene,
  "Stromal",
  "Upregulated"
)

go_stro_down <- perform_go_enrichment(
  dge_results_stro$top_down$Gene,
  "Stromal",
  "Downregulated"
)

cat("\nPathway enrichment analysis complete!\n\n")

# ==============================================================================
# SECTION 10: JMP DATA EXPORT
# ==============================================================================

cat("================================================================================\n")
cat("SECTION 10: JMP DATA EXPORT\n")
cat("================================================================================\n\n")

cat("Preparing data for JMP analysis (for Dr. Nelson)...\n\n")

# 1. Expression matrices
cat("  Exporting expression matrices...\n")
write.csv(expr_epi, "analysis/outputs/jmp_export/expression_epithelial.csv")
write.csv(expr_stro, "analysis/outputs/jmp_export/expression_stromal.csv")

# 2. Metadata
cat("  Exporting metadata...\n")
write.csv(metadata_epi, "analysis/outputs/jmp_export/metadata_epithelial.csv", row.names = FALSE)
write.csv(metadata_stro, "analysis/outputs/jmp_export/metadata_stromal.csv", row.names = FALSE)

# 3. DGE results
cat("  Exporting DGE results...\n")
write.csv(dge_results_epi$dge_full, "analysis/outputs/jmp_export/DGE_epithelial.csv", row.names = FALSE)
write.csv(dge_results_stro$dge_full, "analysis/outputs/jmp_export/DGE_stromal.csv", row.names = FALSE)

# 4. PCA results
cat("  Exporting PCA results...\n")
write.csv(pca_coords, "analysis/outputs/jmp_export/PCA_coordinates.csv")
write.csv(pca_loadings, "analysis/outputs/jmp_export/PCA_loadings.csv")

# 5. Gene annotations
cat("  Exporting gene annotations...\n")
write.csv(gene_panel, "analysis/outputs/jmp_export/gene_annotations.csv", row.names = FALSE)

# 6. Create comprehensive Excel workbook
cat("  Creating comprehensive Excel workbook...\n")
write_xlsx(list(
  Expression_Epithelial = expr_epi %>% rownames_to_column("Gene"),
  Expression_Stromal = expr_stro %>% rownames_to_column("Gene"),
  Metadata_Epithelial = metadata_epi,
  Metadata_Stromal = metadata_stro,
  DGE_Epithelial = dge_results_epi$dge_full,
  DGE_Stromal = dge_results_stro$dge_full,
  PCA_Coordinates = pca_coords %>% rownames_to_column("Sample"),
  Gene_Annotations = gene_panel
), "analysis/outputs/jmp_export/ACF_Complete_Dataset.xlsx")

cat("\nJMP data export complete!\n")
cat("All files saved to: analysis/outputs/jmp_export/\n\n")

# ==============================================================================
# SECTION 11: SUMMARY REPORT
# ==============================================================================

cat("================================================================================\n")
cat("SECTION 11: SUMMARY REPORT\n")
cat("================================================================================\n\n")

# Create summary report
summary_report <- list(
  analysis_date = Sys.time(),
  
  data_summary = list(
    epithelial_samples = ncol(expr_epi),
    stromal_samples = ncol(expr_stro),
    genes_profiled = nrow(expr_epi),
    patients = length(unique(metadata_epi$patient_id))
  ),
  
  dge_summary = rbind(
    dge_results_epi$summary,
    dge_results_stro$summary
  ),
  
  top_findings = list(
    epithelial_top_up = dge_results_epi$top_up[1:10, c("Gene", "log2FoldChange", "padj")],
    epithelial_top_down = dge_results_epi$top_down[1:10, c("Gene", "log2FoldChange", "padj")],
    stromal_top_up = dge_results_stro$top_up[1:10, c("Gene", "log2FoldChange", "padj")],
    stromal_top_down = dge_results_stro$top_down[1:10, c("Gene", "log2FoldChange", "padj")]
  )
)

# Save summary report
saveRDS(summary_report, "analysis/outputs/data/analysis_summary.rds")

# Print summary
cat("ANALYSIS SUMMARY\n")
cat("================\n\n")
cat("Data:\n")
cat("  Patients:", summary_report$data_summary$patients, "\n")
cat("  Epithelial samples:", summary_report$data_summary$epithelial_samples, "\n")
cat("  Stromal samples:", summary_report$data_summary$stromal_samples, "\n")
cat("  Genes profiled:", summary_report$data_summary$genes_profiled, "\n\n")

cat("Differential Expression:\n")
print(summary_report$dge_summary)

cat("\n\nTop Findings:\n")
cat("\nEpithelial - Top Upregulated:\n")
print(summary_report$top_findings$epithelial_top_up)

cat("\nEpithelial - Top Downregulated:\n")
print(summary_report$top_findings$epithelial_top_down)

cat("\nStromal - Top Upregulated:\n")
print(summary_report$top_findings$stromal_top_up)

cat("\nStromal - Top Downregulated:\n")
print(summary_report$top_findings$stromal_top_down)

# ==============================================================================
# ANALYSIS COMPLETE
# ==============================================================================

cat("\n")
cat("================================================================================\n")
cat("ANALYSIS COMPLETE!\n")
cat("================================================================================\n")
cat("\nFinished at:", as.character(Sys.time()), "\n")
cat("\nAll outputs saved to: analysis/outputs/\n")
cat("  - Figures: analysis/outputs/figures/\n")
cat("  - Tables: analysis/outputs/tables/\n")
cat("  - Data: analysis/outputs/data/\n")
cat("  - JMP Export: analysis/outputs/jmp_export/\n")
cat("\n")
cat("Next steps:\n")
cat("  1. Review all figures and tables\n")
cat("  2. Share JMP data with Dr. Nelson\n")
cat("  3. Complete manuscript revisions\n")
cat("  4. Prepare for publication\n")
cat("\n")
cat("================================================================================\n")

# Save session info
writeLines(capture.output(sessionInfo()), "analysis/outputs/data/session_info.txt")

cat("\nSession info saved to: analysis/outputs/data/session_info.txt\n\n")